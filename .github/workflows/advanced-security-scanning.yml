name: Advanced Security & Vulnerability Management

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]
  push:
    branches: [main, develop]
  schedule:
    # Daily security scan at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'comprehensive'
        type: choice
        options:
        - comprehensive
        - quick
        - dependencies
        - secrets
        - api-security
        - compliance

env:
  SEVERITY_THRESHOLD: 'medium'
  FAIL_ON_HIGH: 'true'
  SCAN_TIMEOUT: '30m'

jobs:
  # Comprehensive Security Scan
  comprehensive-security:
    name: Comprehensive Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event.inputs.scan_type == 'comprehensive' || github.event.inputs.scan_type == '' || github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Dependency Security Analysis
      - name: Run comprehensive dependency audit
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=moderate --json > npm-audit.json || true

          echo "Running Snyk security scan..."
          npx snyk test --json > snyk-report.json || true

          echo "Running OWASP dependency check..."
          npx @npmcli/arborist audit --json > arborist-report.json || true

      - name: Advanced dependency analysis
        run: |
          node -e "
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));

          // Analyze dependencies for risk factors
          const deps = Object.entries({...pkg.dependencies, ...pkg.devDependencies});
          const riskAnalysis = {
            totalDependencies: deps.length,
            highRiskDeps: [],
            outdatedDeps: [],
            suspiciousDeps: []
          };

          deps.forEach(([name, version]) => {
            // Check for suspicious patterns
            if (name.includes('eval') || name.includes('exec') || name.includes('shell')) {
              riskAnalysis.suspiciousDeps.push({name, version, reason: 'Potentially dangerous execution'});
            }

            if (name.startsWith('crypto-') && !pkg.author?.includes('security')) {
              riskAnalysis.highRiskDeps.push({name, version, reason: 'Custom crypto implementation'});
            }
          });

          fs.writeFileSync('dependency-risk-analysis.json', JSON.stringify(riskAnalysis, null, 2));
          console.log('Dependency risk analysis completed');
          "

      # Static Application Security Testing (SAST)
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript
          queries: security-extended,security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      - name: Run Semgrep security analysis
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/jwt
            p/nodejs
            p/cwe-top-25
            p/command-injection
            p/sql-injection
            p/xss
            p/crypto
            p/express
          publish: true
          output: 'semgrep-results.sarif'

      - name: Advanced static analysis
        run: |
          echo "Running ESLint security rules..."
          npx eslint src --ext .ts,.tsx --config .eslintrc.json --format=json > eslint-security.json || true

          echo "Running TypeScript compiler security checks..."
          npx tsc --noEmit --strict --noImplicitAny --noImplicitReturns > tsc-security.log 2>&1 || true

          echo "Analyzing code patterns for security issues..."
          node -e "
          const fs = require('fs');
          const path = require('path');
          const glob = require('glob');

          const sourceFiles = glob.sync('src/**/*.ts');
          const securityPatterns = {
            hardcodedSecrets: [],
            sqlInjectionRisks: [],
            xssRisks: [],
            cryptoIssues: [],
            pathTraversal: [],
            evalUsage: []
          };

          sourceFiles.forEach(file => {
            const content = fs.readFileSync(file, 'utf8');
            const lines = content.split('\\n');

            lines.forEach((line, index) => {
              // Check for hardcoded secrets
              if (/password\\s*=\\s*[\"'][^\"']{8,}/.test(line) || /api[_-]?key\\s*=\\s*[\"'][^\"']{20,}/.test(line)) {
                securityPatterns.hardcodedSecrets.push({file, line: index + 1, content: line.trim()});
              }

              // Check for SQL injection risks
              if (/query\\s*\\+\\s*|query.*\\$\\{/.test(line)) {
                securityPatterns.sqlInjectionRisks.push({file, line: index + 1, content: line.trim()});
              }

              // Check for XSS risks
              if (/innerHTML.*\\+\\s*|dangerouslySetInnerHTML/.test(line)) {
                securityPatterns.xssRisks.push({file, line: index + 1, content: line.trim()});
              }

              // Check for eval usage
              if (/eval\\s*\\(|Function\\s*\\(/.test(line)) {
                securityPatterns.evalUsage.push({file, line: index + 1, content: line.trim()});
              }
            });
          });

          fs.writeFileSync('advanced-static-analysis.json', JSON.stringify(securityPatterns, null, 2));
          console.log('Advanced static analysis completed');
          console.log(\`Found \${securityPatterns.hardcodedSecrets.length} potential secrets\`);
          console.log(\`Found \${securityPatterns.sqlInjectionRisks.length} SQL injection risks\`);
          console.log(\`Found \${securityPatterns.xssRisks.length} XSS risks\`);
          "

      # Container Security Analysis
      - name: Build Docker image for scanning
        run: |
          docker build -t workshopsai/cms:security-scan .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'workshopsai/cms:security-scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Run Grype vulnerability scanner
        uses: anchore/scan-action@v3
        with:
          image: 'workshopsai/cms:security-scan'
          format: 'sarif'
          output-file: 'grype-results.sarif'
          fail-build: false

      - name: Dockerfile security analysis
        run: |
          echo "Analyzing Dockerfile for security issues..."
          node -e "
          const fs = require('fs');

          const dockerfile = fs.readFileSync('Dockerfile', 'utf8');
          const dockerSecurityAnalysis = {
            issues: [],
            recommendations: []
          };

          const lines = dockerfile.split('\\n');
          lines.forEach((line, index) => {
            // Check for running as root
            if (line.startsWith('USER') && !line.includes('nonroot') && !line.includes('node')) {
              dockerSecurityAnalysis.issues.push({line: index + 1, issue: 'Container running as privileged user', severity: 'high'});
            }

            // Check for latest tag
            if (/:latest/.test(line)) {
              dockerSecurityAnalysis.issues.push({line: index + 1, issue: 'Using latest tag is not reproducible', severity: 'medium'});
            }

            // Check for sensitive data
            if (/COPY.*\\.env|COPY.*secret/.test(line)) {
              dockerSecurityAnalysis.issues.push({line: index + 1, issue: 'Potential sensitive data copied to container', severity: 'critical'});
            }
          });

          fs.writeFileSync('dockerfile-security-analysis.json', JSON.stringify(dockerSecurityAnalysis, null, 2));
          console.log('Dockerfile security analysis completed');
          "

      # Secrets Detection
      - name: Advanced secrets detection
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request?.base.sha || 'HEAD~1' }}
          head: HEAD
          extra_args: --debug --only-verified --fail

      - name: Git secrets scan
        run: |
          echo "Scanning git history for secrets..."
          git log --all --full-history --patch | grep -i -E "(password|secret|key|token)" | head -20 > git-secrets-scan.txt || true

      # API Security Testing
      - name: API security testing
        run: |
          echo "Starting application for API security testing..."
          export DATABASE_URL=postgresql://test:test@localhost:5432/test
          export REDIS_HOST=localhost
          export NODE_ENV=test
          npm run build
          npm start &
          sleep 30

          echo "Running OWASP ZAP API security scan..."
          docker run --network host -t owasp/zap2docker-stable zap-baseline.py -t http://localhost:3001 || true

          echo "Running Nuclei API security templates..."
          npx nuclei -target http://localhost:3001 -templates /nuclei-templates/apis/ -severity high,critical || true

      # Compliance & Policy Checks
      - name: Compliance analysis
        run: |
          echo "Running compliance checks..."

          # Check for security headers configuration
          node -e "
          const fs = require('fs');
          const glob = require('glob');
          const securityConfig = {
            helmetConfigured: false,
            corsConfigured: false,
            rateLimiting: false,
            authentication: false,
            securityHeaders: {
              'Strict-Transport-Security': false,
              'Content-Security-Policy': false,
              'X-Frame-Options': false,
              'X-Content-Type-Options': false
            }
          };

          try {
            const serverFile = fs.readFileSync('src/index.ts', 'utf8');

            securityConfig.helmetConfigured = /helmet\\(\\)/.test(serverFile);
            securityConfig.corsConfigured = /cors\\(\\)/.test(serverFile);
            securityConfig.rateLimiting = /rateLimit\\(\\)/.test(serverFile);
            securityConfig.authentication = /passport|jwt|auth/.test(serverFile);

            // Check for security headers in responses
            const middlewareFiles = glob.sync('src/**/*middleware*.ts');
            middlewareFiles.forEach(file => {
              const content = fs.readFileSync(file, 'utf8');
              if (/hsts/.test(content)) securityConfig.securityHeaders['Strict-Transport-Security'] = true;
              if (/csp/.test(content)) securityConfig.securityHeaders['Content-Security-Policy'] = true;
            });
          } catch (e) {
            console.log('Could not analyze security configuration');
          }

          fs.writeFileSync('compliance-analysis.json', JSON.stringify(securityConfig, null, 2));
          console.log('Compliance analysis completed');
          "

      - name: Generate comprehensive security report
        run: |
          node -e "
          const fs = require('fs');

          // Read all analysis results
          const dependencyRisk = JSON.parse(fs.readFileSync('dependency-risk-analysis.json', 'utf8'));
          const staticAnalysis = JSON.parse(fs.readFileSync('advanced-static-analysis.json', 'utf8'));
          const dockerAnalysis = JSON.parse(fs.readFileSync('dockerfile-security-analysis.json', 'utf8'));
          const complianceAnalysis = JSON.parse(fs.readFileSync('compliance-analysis.json', 'utf8'));

          const securityReport = {
            timestamp: new Date().toISOString(),
            summary: {
              totalIssues: staticAnalysis.hardcodedSecrets.length + staticAnalysis.sqlInjectionRisks.length +
                          staticAnalysis.xssRisks.length + dockerAnalysis.issues.length,
              criticalIssues: dockerAnalysis.issues.filter(i => i.severity === 'critical').length +
                             staticAnalysis.hardcodedSecrets.length,
              highIssues: staticAnalysis.sqlInjectionRisks.length + staticAnalysis.evalUsage.length +
                          dockerAnalysis.issues.filter(i => i.severity === 'high').length,
              mediumIssues: staticAnalysis.xssRisks.length + dockerAnalysis.issues.filter(i => i.severity === 'medium').length
            },
            categories: {
              secrets: staticAnalysis.hardcodedSecrets,
              injection: staticAnalysis.sqlInjectionRisks,
              xss: staticAnalysis.xssRisks,
              container: dockerAnalysis,
              compliance: complianceAnalysis,
              dependencies: dependencyRisk
            },
            recommendations: []
          };

          // Generate recommendations
          if (securityReport.summary.criticalIssues > 0) {
            securityReport.recommendations.push('ðŸš¨ Address critical security issues immediately');
          }
          if (securityReport.summary.highIssues > 5) {
            securityReport.recommendations.push('âš ï¸ Multiple high-severity issues require attention');
          }
          if (!complianceAnalysis.helmetConfigured) {
            securityReport.recommendations.push('Configure helmet.js for security headers');
          }
          if (!complianceAnalysis.rateLimiting) {
            securityReport.recommendations.push('Implement rate limiting to prevent DDoS attacks');
          }

          fs.writeFileSync('comprehensive-security-report.json', JSON.stringify(securityReport, null, 2));
          console.log('Comprehensive security report generated');
          console.log(\`Total security issues found: \${securityReport.summary.totalIssues}\`);
          console.log(\`Critical issues: \${securityReport.summary.criticalIssues}\`);
          console.log(\`High issues: \${securityReport.summary.highIssues}\`);
          "

      - name: Create security issue if critical findings
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('comprehensive-security-report.json', 'utf8'));

            if (report.summary.criticalIssues > 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Critical Security Vulnerabilities Detected',
                body: `
                Automated security scan found **${report.summary.criticalIssues} critical** security vulnerabilities that require immediate attention.

                ### Critical Issues Summary:
                - **Hardcoded Secrets**: ${report.categories.secrets.length}
                - **SQL Injection Risks**: ${report.categories.injection.length}
                - **Container Issues**: ${report.categories.container.issues.filter(i => i.severity === 'critical').length}

                ### Immediate Actions Required:
                1. Review and remove any hardcoded secrets
                2. Fix SQL injection vulnerabilities
                3. Update container security configuration
                4. Run security tests locally

                **This issue was automatically created by the security scanning workflow.**
                `,
                labels: ['security', 'critical', 'urgent', 'automated']
              });
            }

      - name: Upload security artifacts
        uses: actions/upload-artifact@v3
        with:
          name: comprehensive-security-scan
          path: |
            npm-audit.json
            snyk-report.json
            semgrep-results.sarif
            trivy-results.sarif
            grype-results.sarif
            advanced-static-analysis.json
            comprehensive-security-report.json
            dockerfile-security-analysis.json
            compliance-analysis.json

  # Quick Security Scan
  quick-security:
    name: Quick Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.inputs.scan_type == 'quick'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Quick dependency audit
        run: |
          npm audit --audit-level=high || true
          npx semgrep --config=auto src/ --severity=ERROR || true

      - name: Quick secrets scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: HEAD~1
          head: HEAD
          extra_args: --fail-on-issue

  # Security Dashboard Update
  update-security-dashboard:
    name: Update Security Dashboard
    runs-on: ubuntu-latest
    needs: [comprehensive-security, quick-security]
    if: always() && (needs.comprehensive-security.result == 'success' || needs.quick-security.result == 'success')

    steps:
      - name: Update security metrics
        uses: actions/github-script@v7
        with:
          script: |
            // Update repository security metrics or dashboard
            console.log('Security scan completed, updating dashboard...');

            // Create a summary in the repository's security page
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              target_url: \`https://github.com/\${context.repo.owner}/\${context.repo.repo}/security\`,
              description: 'Security scan completed successfully',
              context: 'security-scan'
            });

  # Security Notification
  notify-security:
    name: Security Notifications
    runs-on: ubuntu-latest
    needs: [comprehensive-security, quick-security]
    if: failure() && (github.event_name == 'schedule' || github.event.inputs.scan_type == 'comprehensive')

    steps:
      - name: Send security alert
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // Create security alert issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Security Scan Failed',
              body: `
              The comprehensive security scan has failed. This requires immediate attention.

              **Scan Details:**
              - **Trigger**: ${{ github.event_name }}
              - **Commit**: ${{ github.sha }}
              - **Branch**: ${{ github.ref_name }}
              - **Time**: ${new Date().toISOString()}

              **Action Required:**
              1. Review the failed workflow logs
              2. Identify the security issues
              3. Fix vulnerabilities immediately
              4. Re-run security scans

              **Security Team Contact:** [Add security team contact information]
              `,
              labels: ['security', 'urgent', 'alert']
            });

            // Update commit status
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'failure',
              target_url: \`https://github.com/\${context.repo.owner}/\${context.repo.repo}/actions/runs/\${context.run_id}\`,
              description: 'Security scan failed - action required',
              context: 'security-alert'
            });