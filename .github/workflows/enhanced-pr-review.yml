name: Enhanced PR Review & Code Quality

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

env:
  NODE_VERSION: '20'
  MIN_COVERAGE: 80
  MAX_COMPLEXITY: 10

jobs:
  # Automated Code Review
  code-review:
    name: Automated Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: |
          npm run lint -- --format=json > lint-results.json
          npm run lint:fix

      - name: Type checking
        run: npm run typecheck

      - name: Code complexity analysis
        run: |
          npx plato -r -d complexity-report -t "Complexity Report" -x .json src/
          echo "Complexity analysis completed"

      - name: Generate code review summary
        run: |
          node -e "
          const fs = require('fs');
          const lintResults = JSON.parse(fs.readFileSync('lint-results.json', 'utf8'));

          const review = {
            summary: {
              totalIssues: lintResults.length,
              errors: lintResults.filter(r => r.severity === 2).length,
              warnings: lintResults.filter(r => r.severity === 1).length
            },
            recommendations: []
          };

          // Add specific recommendations
          if (review.summary.errors > 0) {
            review.recommendations.push('ðŸš¨ Fix critical linting errors before merging');
          }
          if (review.summary.warnings > 5) {
            review.recommendations.push('âš ï¸ Consider addressing style warnings for better code quality');
          }

          fs.writeFileSync('code-review-summary.json', JSON.stringify(review, null, 2));
          console.log('Code review summary generated');
          "

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = JSON.parse(fs.readFileSync('code-review-summary.json', 'utf8'));

            const comment = `
            ## ðŸ¤– Automated Code Review

            ### Summary
            - **Total Issues**: ${review.summary.totalIssues}
            - **Errors**: ${review.summary.errors} ðŸš¨
            - **Warnings**: ${review.summary.warnings} âš ï¸

            ### Recommendations
            ${review.recommendations.map(rec => `- ${rec}`).join('\n')}

            ### Next Steps
            - [ ] Review and fix critical issues
            - [ ] Run tests locally to verify fixes
            - [ ] Update documentation if needed
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload review artifacts
        uses: actions/upload-artifact@v3
        with:
          name: code-review-results
          path: |
            lint-results.json
            code-review-summary.json
            complexity-report/

  # Performance Impact Analysis
  performance-analysis:
    name: Performance Impact Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Analyze bundle size impact
        run: |
          npm run build
          node -e "
          const fs = require('fs');
          const path = require('path');

          const distDir = './dist';
          let totalSize = 0;
          let fileCount = 0;

          if (fs.existsSync(distDir)) {
            const files = fs.readdirSync(distDir, { recursive: true });
            files.forEach(file => {
              if (fs.statSync(path.join(distDir, file)).isFile()) {
                const size = fs.statSync(path.join(distDir, file)).size;
                totalSize += size;
                fileCount++;
              }
            });
          }

          const analysis = {
            totalSize: totalSize,
            fileCount: fileCount,
            averageFileSize: totalSize / fileCount,
            timestamp: new Date().toISOString()
          };

          fs.writeFileSync('bundle-analysis.json', JSON.stringify(analysis, null, 2));
          console.log(\`Bundle analysis: \${totalSize} bytes across \${fileCount} files\`);
          "

      - name: Memory leak detection
        run: |
          npm run test:performance || true

      - name: Performance regression check
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = JSON.parse(fs.readFileSync('bundle-analysis.json', 'utf8'));

            const sizeKB = Math.round(analysis.totalSize / 1024);
            const comment = `
            ## ðŸ“Š Performance Analysis

            ### Bundle Size Impact
            - **Total Size**: ${sizeKB} KB
            - **File Count**: ${analysis.fileCount}
            - **Average File Size**: ${Math.round(analysis.averageFileSize / 1024)} KB

            ### Performance Recommendations
            ${sizeKB > 1000 ? 'âš ï¸ Consider bundle size optimization techniques' : 'âœ… Bundle size is within acceptable limits'}

            ### Next Steps
            - [ ] Review bundle splitting strategy if needed
            - [ ] Check for unused dependencies
            - [ ] Validate performance in staging environment
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Security Review
  security-review:
    name: Security Review
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: |
          npm audit --audit-level=moderate --json > security-audit.json
          npm run security:scan || true

      - name: Check for secrets in diff
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified

      - name: Security analysis
        run: |
          node -e "
          const fs = require('fs');
          const audit = JSON.parse(fs.readFileSync('security-audit.json', 'utf8'));

          const vulnerabilities = audit.vulnerabilities || [];
          const highVulns = vulnerabilities.filter(v => v.severity === 'high' || v.severity === 'critical');

          const securityReport = {
            totalVulnerabilities: vulnerabilities.length,
            highSeverityVulnerabilities: highVulns.length,
            recommendations: []
          };

          if (highVulns.length > 0) {
            securityReport.recommendations.push('ðŸš¨ Address high/critical security vulnerabilities');
          }
          if (vulnerabilities.length > 10) {
            securityReport.recommendations.push('âš ï¸ Consider dependency updates for better security posture');
          }

          fs.writeFileSync('security-review.json', JSON.stringify(securityReport, null, 2));
          "

      - name: Security review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const securityReport = JSON.parse(fs.readFileSync('security-review.json', 'utf8'));

            const comment = `
            ## ðŸ”’ Security Review

            ### Security Analysis
            - **Total Vulnerabilities**: ${securityReport.totalVulnerabilities}
            - **High Severity**: ${securityReport.highSeverityVulnerabilities} ðŸš¨

            ### Security Recommendations
            ${securityReport.recommendations.map(rec => `- ${rec}`).join('\n')}

            ### Security Checklist
            - [ ] No hardcoded secrets or credentials
            - [ ] Input validation implemented
            - [ ] Error handling doesn't leak sensitive information
            - [ ] Authentication/authorization properly implemented
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Documentation Review
  documentation-review:
    name: Documentation Review
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check documentation coverage
        run: |
          echo "Checking documentation files..."

          # Check for README updates
          if [[ $(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E "(README|CHANGELOG|docs/)" | wc -l) -gt 0 ]]; then
            echo "Documentation files updated" > docs-updated.txt
          else
            echo "No documentation updates found" > docs-updated.txt
          fi

          # Check for JSDoc coverage
          find src -name "*.ts" -o -name "*.js" | head -10 > source-files.txt

      - name: Documentation review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const docsUpdated = fs.readFileSync('docs-updated.txt', 'utf8').includes('updated');
            const sourceFiles = fs.readFileSync('source-files.txt', 'utf8').split('\n').filter(f => f.trim());

            const comment = `
            ## ðŸ“š Documentation Review

            ### Documentation Status
            ${docsUpdated ? 'âœ… Documentation files updated' : 'â„¹ï¸ No documentation changes detected'}

            ### Documentation Checklist
            - [ ] README updated if API changes
            - [ ] JSDoc comments added for new functions
            - [ ] CHANGELOG updated for breaking changes
            - [ ] Technical documentation updated
            - [ ] User-facing documentation updated

            ### Files Changed
            \`${{ github.event.pull_request.changed_files }}\` files modified

            ${docsUpdated ? '' : 'ðŸ’¡ Consider updating documentation for this change'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # PR Readiness Check
  pr-readiness:
    name: PR Readiness Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [code-review, performance-analysis, security-review, documentation-review]
    if: always()

    steps:
      - name: Check PR readiness
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              codeReview: '${{ needs.code-review.result }}',
              performance: '${{ needs.performance-analysis.result }}',
              security: '${{ needs.security-review.result }}',
              documentation: '${{ needs.documentation-review.result }}'
            };

            const allPassed = Object.values(results).every(result => result === 'success');
            const failures = Object.entries(results).filter(([_, result]) => result !== 'success');

            const status = allPassed ? 'âœ… Ready for Review' : 'âš ï¸ Action Required';
            const statusIcon = allPassed ? 'ðŸŸ¢' : 'ðŸŸ¡';

            const comment = `
            ${statusIcon} ## PR Readiness Status: ${status}

            ### Check Results
            - **Code Review**: ${{ needs.code-review.result === 'success' && 'âœ… Passed' || 'âŒ Failed' }}
            - **Performance**: ${{ needs.performance-analysis.result === 'success' && 'âœ… Passed' || 'âŒ Failed' }}
            - **Security**: ${{ needs.security-review.result === 'success' && 'âœ… Passed' || 'âŒ Failed' }}
            - **Documentation**: ${{ needs.documentation-review.result === 'success' && 'âœ… Passed' || 'âŒ Failed' }}

            ${failures.length > 0 ? `
            ### Required Actions
            ${failures.map(([check, _]) => `- Fix ${check} issues`).join('\n')}
            ` : ''}

            ### Merge Requirements
            - [ ] All automated checks pass
            - [ ] At least one human review
            - [ ] No merge conflicts
            - [ ] Tests passing
            `;

            // Update PR description or add comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

            // Set PR status
            if (allPassed) {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: context.sha,
                state: 'success',
                target_url: \`https://github.com/\${context.repo.owner}/\${context.repo.repo}/pull/\${context.issue.number}\`,
                description: 'PR is ready for merge',
                context: 'pr-readiness-check'
              });
            } else {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: context.sha,
                state: 'pending',
                target_url: \`https://github.com/\${context.repo.owner}/\${context.repo.repo}/pull/\${context.issue.number}\`,
                description: 'PR needs attention before merge',
                context: 'pr-readiness-check'
              });
            }